GLOBAL processed_magic_numbers ← EMPTY_SET            // список обработанных ордеров

INPUT TARGET_RR                                       // требуемый риск/ревард (RR)
INPUT MOVE_TO_BE_ONLY (BOOLEAN)                       // BE: TRUE — только перевод в безубыток; FALSE — перевод + частичное закрытие

CONSTANT MIN_LOT ← BROKER_MIN_LOT()
CONSTANT LOT_STEP ← BROKER_LOT_STEP()

FUNCTION ON_TICK()
    open_orders ← GET_OPEN_ORDERS()                   // активные рыночные позиции

    FOR EACH order IN open_orders
        IF order.magic_number IN processed_magic_numbers
            CONTINUE                                  // уже обработан

        current_bid ← GET_CURRENT_BID(order.symbol)
        current_ask ← GET_CURRENT_ASK(order.symbol)

        IF HAS_REACHED_TARGET_RR(order, current_bid, current_ask, TARGET_RR) = FALSE
            CONTINUE

        // Достигнут целевой RR — переводим SL в цену открытия
        MOVE_STOP_LOSS(order.id, order.entry_price)

        IF MOVE_TO_BE_ONLY = FALSE
            fraction_to_close ← 1 / TARGET_RR
            volume_to_close ← ROUND_TO_STEP(order.volume * fraction_to_close, LOT_STEP)

            IF volume_to_close ≥ MIN_LOT AND volume_to_close < order.volume
                CLOSE_PARTIAL(order.id, volume_to_close)
            ENDIF
        ENDIF

        ADD_TO_SET(processed_magic_numbers, order.magic_number)
    ENDFOR
END FUNCTION


FUNCTION HAS_REACHED_TARGET_RR(order, current_bid, current_ask, target_rr) RETURNS BOOLEAN
    entry_price ← order.entry_price
    initial_sl ← order.initial_stop_loss
    initial_risk ← ABS(entry_price - initial_sl)

    IF initial_risk NEAR_ZERO
        RETURN FALSE
    ENDIF

    IF order.type = "BUY"
        reward_now ← current_bid - entry_price
    ELSE IF order.type = "SELL"
        reward_now ← entry_price - current_ask
    ENDIF

    current_rr ← reward_now / initial_risk
    RETURN current_rr ≥ target_rr
END FUNCTION


// ===== СИСТЕМНЫЕ ВЫЗОВЫ (АБСТРАКЦИЯ) =====
// GET_OPEN_ORDERS() → список ордеров с полями: id, symbol, type, entry_price, stop_loss, initial_stop_loss, volume, magic_number
// GET_CURRENT_BID(symbol) / GET_CURRENT_ASK(symbol)
// MOVE_STOP_LOSS(order_id, new_sl)
// CLOSE_PARTIAL(order_id, volume)
// BROKER_MIN_LOT(), BROKER_LOT_STEP()
// ROUND_TO_STEP(value, step)
// ADD_TO_SET(set, value)
